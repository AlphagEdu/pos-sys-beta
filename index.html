<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meesho Seller Hub Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <style>
        :root {
            --primary: #6f42c1;
            --primary-light: #8d6bd6;
            --secondary: #ff6b6b;
            --success: #28a745;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --border-radius: 16px;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            min-height: 100vh;
            padding: 16px;
            color: var(--dark);
            font-size: 15px;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
            min-height: 95vh;
        }

        /* Header styles */
        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 20px 16px;
            text-align: center;
            position: relative;
            z-index: 10;
        }

        .app-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .seller-switcher {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 12px;
        }

        .seller-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50px;
            padding: 6px 16px;
            color: white;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .seller-btn.active {
            background: white;
            color: var(--primary);
            font-weight: 600;
        }

        /* Reset button */
        .reset-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            z-index: 20;
        }

        .reset-btn:hover {
            background: rgba(255, 0, 0, 0.3);
            transform: rotate(360deg) scale(1.1);
        }

        /* Main content area */
        .view-container {
            padding: 24px 16px 80px;
            min-height: calc(100vh - 140px);
            overflow-y: auto;
            max-height: calc(100vh - 140px);
        }

        /* Home screen grid */
        .home-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 20px;
        }

        .feature-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 2px solid transparent;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-light);
        }

        .icon-container {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(111, 66, 193, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
        }

        .icon-container i {
            font-size: 20px;
            color: var(--primary);
        }

        .feature-card h3 {
            font-size: 1rem;
            margin-bottom: 6px;
            color: var(--dark);
        }

        .feature-card p {
            color: var(--gray);
            font-size: 0.75rem;
        }

        /* Bottom navigation */
        .nav-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
            max-width: 480px;
            margin: 0 auto;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--gray);
            font-size: 0.7rem;
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 12px;
            transition: var(--transition);
        }

        .nav-item.active {
            color: var(--primary);
            background: rgba(111, 66, 193, 0.1);
        }

        .nav-item i {
            font-size: 18px;
            margin-bottom: 4px;
        }

        /* View management */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .view-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            cursor: pointer;
            border: none;
            font-size: 16px;
        }

        .view-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
        }

        /* Form styles */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--light-gray);
            border-radius: 12px;
            font-size: 0.95rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(111, 66, 193, 0.2);
        }

        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-light);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #ff5252;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* Barcode styles */
        .barcode-container {
            margin: 20px 0;
            padding: 16px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
        }

        #barcode {
            width: 100%;
            height: 100px;
            margin: 10px auto;
        }

        .barcode-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .barcode-actions .btn {
            flex: 1;
        }

        /* Inventory item styles */
        .inventory-item {
            background: white;
            border-radius: var(--border-radius);
            padding: 14px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            position: relative;
        }

        .item-info {
            flex: 1;
        }

        .item-info h4 {
            font-size: 0.95rem;
            margin-bottom: 4px;
        }

        .item-info p {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .stock-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stock-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            cursor: pointer;
            border: none;
        }

        .stock-count {
            min-width: 36px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .stock-input {
            width: 70px;
            padding: 8px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .delete-item {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--secondary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            cursor: pointer;
            border: none;
        }

        /* Scanner styles */
        .scanner-container {
            background: black;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
            height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #scanner-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .scanner-frame {
            width: 80%;
            max-width: 250px;
            height: 120px;
            border: 4px solid white;
            border-radius: 12px;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.5);
        }

        /* Stats and dashboard styles */
        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 14px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .stat-card.profit {
            border-top: 4px solid var(--success);
        }

        .stat-card.loss {
            border-top: 4px solid var(--secondary);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 6px 0;
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.8rem;
        }

        .profit {
            color: var(--success);
        }

        .loss {
            color: var(--secondary);
        }

        .view-details-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 4px 10px;
            font-size: 0.7rem;
            margin-top: 8px;
            cursor: pointer;
        }

        /* Filter styles */
        .filter-container {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .filter-btn {
            flex: 1;
            padding: 8px;
            background: var(--light-gray);
            border: none;
            border-radius: 12px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Table styles */
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            font-size: 0.85rem;
        }

        .summary-table th,
        .summary-table td {
            padding: 10px 12px;
            text-align: left;
        }

        .summary-table th {
            background: var(--primary);
            color: white;
            font-weight: 500;
            font-size: 0.8rem;
        }

        .summary-table tr:nth-child(even) {
            background: var(--light-gray);
        }

        /* Returns tabs */
        .tabs {
            display: flex;
            margin-bottom: 16px;
            background: var(--light-gray);
            border-radius: 12px;
            padding: 4px;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.85rem;
        }

        .tab.active {
            background: white;
            box-shadow: var(--shadow);
            font-weight: 600;
            color: var(--primary);
        }

        /* Courier options */
        .courier-option {
            display: flex;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: var(--shadow);
        }

        .courier-color {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .color-sf { background: #ff9f43; }
        .color-ec { background: #0abde3; }
        .color-dl { background: #10ac84; }
        .color-vm { background: #5f27cd; }

        .courier-info {
            flex: 1;
        }

        .courier-name {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 0.9rem;
        }

        .courier-charge input {
            width: 90px;
            padding: 6px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            font-size: 0.85rem;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: var(--shadow);
            z-index: 100;
            animation: fadeInOut 3s forwards;
            font-size: 0.9rem;
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: var(--transition);
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 400px;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            transform: translateY(20px);
            transition: var(--transition);
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .close-modal {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 16px;
        }

        /* Charge configuration */
        .charge-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .charge-label {
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .charge-input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 30px 16px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 12px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 0.85rem;
        }

        /* Confirmation popup */
        .confirmation-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: var(--transition);
        }

        .confirmation-popup.active {
            opacity: 1;
            pointer-events: all;
        }

        .confirmation-content {
            background: white;
            width: 90%;
            max-width: 280px;
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .checkmark {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: var(--success);
            margin: 0 auto 16px;
            position: relative;
            animation: scaleIn 0.3s forwards;
        }

        .checkmark::after {
            content: '';
            position: absolute;
            left: 20px;
            top: 35px;
            width: 20px;
            height: 4px;
            background: white;
            transform: rotate(45deg);
        }

        .checkmark::before {
            content: '';
            position: absolute;
            left: 16px;
            top: 30px;
            width: 12px;
            height: 4px;
            background: white;
            transform: rotate(-45deg);
        }

        /* Purchase items */
        .purchase-item {
            margin-bottom: 10px;
        }

        .item-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .item-row input {
            flex: 1;
        }

        .item-row input.item-name {
            flex: 2;
        }

        /* Daily records */
        #daily-records-table th {
            font-size: 0.8rem;
            padding: 8px 10px;
        }

        #daily-records-table td {
            font-size: 0.8rem;
            padding: 8px 10px;
        }

        /* Animations */
        @keyframes scaleIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        @keyframes fadeInOut {
            0% { opacity: 0; bottom: 50px; }
            10% { opacity: 1; bottom: 80px; }
            90% { opacity: 1; bottom: 80px; }
            100% { opacity: 0; bottom: 50px; }
        }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            .app-container {
                max-width: 480px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <h1>Meesho Seller Hub Pro</h1>
            <p>Professional Inventory & Sales Management</p>
            <button id="reset-all-btn" class="reset-btn" title="Reset all data">♻️</button>
            <div class="seller-switcher">
                <button class="seller-btn active" data-seller="AAA">AAA</button>
                <button class="seller-btn" data-seller="RA">RA</button>
                <button class="seller-btn" data-seller="combined">Combined</button>
            </div>
        </div>
        
        <div class="view-container">
            <!-- Home View -->
            <div id="home-view" class="view active">
                <div class="home-grid">
                    <div class="feature-card" data-target="barcode-view">
                        <div class="icon-container">
                            <i>📊</i>
                        </div>
                        <h3>Barcode Generator</h3>
                        <p>Create & download scannable barcodes</p>
                    </div>
                    
                    <div class="feature-card" data-target="inventory-view">
                        <div class="icon-container">
                            <i>📦</i>
                        </div>
                        <h3>Inventory Manager</h3>
                        <p>Manage stock with barcode scanning</p>
                    </div>
                    
                    <div class="feature-card" data-target="scanner-view">
                        <div class="icon-container">
                            <i>📱</i>
                        </div>
                        <h3>Order Scanner</h3>
                        <p>Scan orders to update inventory</p>
                    </div>
                    
                    <div class="feature-card" data-target="returns-view">
                        <div class="icon-container">
                            <i>🔄</i>
                        </div>
                        <h3>Returns Management</h3>
                        <p>Process returns with courier tracking</p>
                    </div>
                    
                    <div class="feature-card" data-target="dashboard-view">
                        <div class="icon-container">
                            <i>📈</i>
                        </div>
                        <h3>Summary Dashboard</h3>
                        <p>Analytics for orders, returns & profit</p>
                    </div>
                    
                    <div class="feature-card" data-target="purchase-view">
                        <div class="icon-container">
                            <i>🛒</i>
                        </div>
                        <h3>Purchase History</h3>
                        <p>Track vendor purchases and expenses</p>
                    </div>
                </div>
            </div>
            
            <!-- Barcode Generator View -->
            <div id="barcode-view" class="view">
                <div class="view-header">
                    <div class="back-btn">←</div>
                    <h2 class="view-title">Barcode Generator</h2>
                </div>
                
                <form id="barcode-form">
                    <div class="form-group">
                        <label for="product-name">Product Name</label>
                        <input type="text" id="product-name" class="form-control" placeholder="Enter product name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="product-size">Size</label>
                        <input type="text" id="product-size" class="form-control" placeholder="Enter size" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="product-color">Color</label>
                        <input type="text" id="product-color" class="form-control" placeholder="Enter color" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="profit-margin">Profit Margin (₹)</label>
                        <input type="number" id="profit-margin" class="form-control" placeholder="Enter profit in rupees" min="0" step="0.01" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Generate Barcode</button>
                </form>
                
                <div class="barcode-container" id="barcode-result" style="display:none;">
                    <h3>Your Product Barcode</h3>
                    <svg id="barcode"></svg>
                    <div class="barcode-actions">
                        <button id="download-barcode" class="btn btn-primary">Download</button>
                        <button id="save-barcode" class="btn btn-secondary">Save to Inventory</button>
                    </div>
                </div>
            </div>
            
            <!-- Inventory Manager View -->
            <div id="inventory-view" class="view">
                <div class="view-header">
                    <div class="back-btn">←</div>
                    <h2 class="view-title">Inventory Manager</h2>
                </div>
                
                <div class="inventory-list" id="inventory-list">
                    <div class="empty-state">
                        <i>📦</i>
                        <h3>No products in inventory</h3>
                        <p>Add products using the barcode generator</p>
                    </div>
                </div>
                
                <button id="update-inventory" class="btn btn-primary">Update All Inventory</button>
            </div>
            
            <!-- Order Scanner View -->
            <div id="scanner-view" class="view">
                <div class="view-header">
                    <div class="back-btn">←</div>
                    <h2 class="view-title">Order Scanner</h2>
                </div>
                
                <div class="scanner-container">
                    <video id="scanner-video"></video>
                    <div class="scanner-overlay">
                        <div class="scanner-frame"></div>
                    </div>
                </div>
                
                <div class="scanned-result" id="scanned-result" style="display:none;">
                    <div class="form-group">
                        <label>Scanned Product</label>
                        <input type="text" class="form-control" id="scanned-product" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="order-quantity">Quantity Sold</label>
                        <input type="number" id="order-quantity" class="form-control" value="1" min="1">
                    </div>
                    
                    <button id="confirm-order" class="btn btn-primary">Confirm Order</button>
                </div>
                
                <button id="start-scanning" class="btn btn-primary">Start Scanning</button>
                <button id="stop-scanning" class="btn btn-secondary" style="display:none; margin-top:10px;">Stop Scanning</button>
            </div>
            
            <!-- Returns Management View -->
            <div id="returns-view" class="view">
                <div class="view-header">
                    <div class="back-btn">←</div>
                    <h2 class="view-title">Returns Management</h2>
                    <div style="margin-left: auto;">
                        <button id="configure-charges" class="seller-btn" style="background: white; color: var(--primary);">⚙️ Charges</button>
                    </div>
                </div>
                
                <div class="tabs">
                    <div class="tab active" data-tab="customer">Customer Returns</div>
                    <div class="tab" data-tab="rto">RTO Returns</div>
                    <div class="tab" data-tab="rescan">Rescan Items</div>
                </div>
                
                <!-- Customer Returns Section -->
                <div class="return-section" id="customer-return-section">
                    <div class="form-group">
                        <label for="return-courier">Courier Partner</label>
                        <select id="return-courier" class="form-control">
                            <option value="shadowfax">Shadowfax</option>
                            <option value="ecom">Ecom</option>
                            <option value="delhivery">Delhivery</option>
                            <option value="valmo">Valmo</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="customer-return-qty">Number of Returns</label>
                        <input type="number" id="customer-return-qty" class="form-control" placeholder="Enter number of returns" min="1" value="1">
                    </div>
                    
                    <div class="form-group">
                        <label for="wrong-return-qty">Number of Wrong Returns</label>
                        <input type="number" id="wrong-return-qty" class="form-control" placeholder="Enter number of wrong returns" min="0" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="claims-received">Claims Received</label>
                        <input type="number" id="claims-received" class="form-control" placeholder="Enter number of claims" min="0" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="compensation-amount">Compensation Amount (₹)</label>
                        <input type="number" id="compensation-amount" class="form-control" placeholder="Enter compensation amount" min="0" value="0" step="0.01">
                    </div>
                    
                    <button id="process-customer-return" class="btn btn-primary">Process Customer Return</button>
                </div>
                
                <!-- RTO Returns Section -->
                <div class="return-section" id="rto-return-section" style="display:none;">
                    <div class="form-group">
                        <label for="rto-courier">Courier Partner</label>
                        <select id="rto-courier" class="form-control">
                            <option value="shadowfax">Shadowfax</option>
                            <option value="ecom">Ecom</option>
                            <option value="delhivery">Delhivery</option>
                            <option value="valmo">Valmo</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="rto-return-qty">Number of RTO Returns</label>
                        <input type="number" id="rto-return-qty" class="form-control" placeholder="Enter number of RTO returns" min="1" value="1">
                    </div>
                    
                    <button id="process-rto-return" class="btn btn-primary">Process RTO Return</button>
                </div>
                
                <!-- Rescan Items Section -->
                <div class="return-section" id="rescan-section" style="display:none;">
                    <div class="scanner-container" style="height: 200px;">
                        <video id="rescan-video"></video>
                        <div class="scanner-overlay">
                            <div class="scanner-frame"></div>
                        </div>
                    </div>
                    
                    <div class="scanned-rescan-result" id="scanned-rescan-result" style="display:none;">
                        <div class="form-group">
                            <label>Scanned Product</label>
                            <input type="text" class="form-control" id="rescan-product" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label for="rescan-quantity">Quantity to Add</label>
                            <input type="number" id="rescan-quantity" class="form-control" value="1" min="1">
                        </div>
                        
                        <button id="confirm-rescan" class="btn btn-primary">Add to Inventory</button>
                    </div>
                    
                    <button id="start-rescan" class="btn btn-primary">Start Rescan</button>
                    <button id="stop-rescan" class="btn btn-secondary" style="display:none; margin-top:10px;">Stop Rescan</button>
                </div>
            </div>
            
            <!-- Dashboard View -->
            <div id="dashboard-view" class="view">
                <div class="view-header">
                    <div class="back-btn">←</div>
                    <h2 class="view-title">Summary Dashboard</h2>
                </div>
                
                <div class="filter-container">
                    <button class="filter-btn active" data-period="daily">Today</button>
                    <button class="filter-btn" data-period="weekly">This Week</button>
                    <button class="filter-btn" data-period="monthly">This Month</button>
                    <button class="filter-btn" data-period="all">All Time</button>
                </div>
                
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-label">Total Orders</div>
                        <div class="stat-value" id="total-orders">0</div>
                        <button class="view-details-btn" data-type="orders">View Details</button>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-label">Total Returns</div>
                        <div class="stat-value" id="total-returns">0</div>
                        <button class="view-details-btn" data-type="returns">View Details</button>
                    </div>
                    
                    <div class="stat-card profit">
                        <div class="stat-label">Total Earnings</div>
                        <div class="stat-value" id="total-earnings">₹0</div>
                    </div>
                    
                    <div class="stat-card loss">
                        <div class="stat-label">Return Charges</div>
                        <div class="stat-value" id="return-charges">₹0</div>
                    </div>
                    
                    <div class="stat-card" style="grid-column: span 2;">
                        <div class="stat-label">Net Profit/Loss</div>
                        <div class="stat-value" id="net-profit">₹0</div>
                    </div>
                </div>
                
                <!-- Daily Records Table (hidden by default) -->
                <div id="daily-records" class="chart-container" style="display:none;">
                    <div class="chart-title" id="records-title">Daily Records</div>
                    <table class="summary-table" id="daily-records-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Orders</th>
                                <th>Returns</th>
                                <th>Earnings</th>
                                <th>Charges</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Purchase History View -->
            <div id="purchase-view" class="view">
                <div class="view-header">
                    <div class="back-btn">←</div>
                    <h2 class="view-title">Purchase History</h2>
                </div>
                
                <form id="purchase-form">
                    <div class="form-group">
                        <label for="vendor-name">Vendor Name</label>
                        <input type="text" id="vendor-name" class="form-control" placeholder="Enter vendor name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="purchase-date">Purchase Date</label>
                        <input type="date" id="purchase-date" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Items Purchased</label>
                        <div id="purchase-items">
                            <div class="purchase-item">
                                <div class="item-row">
                                    <input type="text" class="form-control item-name" placeholder="Item name">
                                    <input type="number" class="form-control item-qty" placeholder="Qty" min="1">
                                    <input type="number" class="form-control item-price" placeholder="Price (₹)" min="0" step="0.01">
                                </div>
                            </div>
                        </div>
                        <button type="button" id="add-item" class="btn btn-secondary" style="margin-top: 10px;">+ Add Item</button>
                    </div>
                    
                    <div class="form-group">
                        <label for="total-amount">Total Amount Paid (₹)</label>
                        <input type="number" id="total-amount" class="form-control" placeholder="Enter total amount" min="0" step="0.01" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Save Purchase</button>
                </form>
                
                <div class="chart-container" style="margin-top: 30px;">
                    <div class="chart-title">Recent Purchases</div>
                    <table class="summary-table" id="purchases-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Vendor</th>
                                <th>Items</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="nav-bottom">
            <div class="nav-item active" data-target="home-view">
                <i>🏠</i>
                <span>Home</span>
            </div>
            <div class="nav-item" data-target="barcode-view">
                <i>📊</i>
                <span>Barcode</span>
            </div>
            <div class="nav-item" data-target="inventory-view">
                <i>📦</i>
                <span>Inventory</span>
            </div>
            <div class="nav-item" data-target="scanner-view">
                <i>📱</i>
                <span>Scan</span>
            </div>
            <div class="nav-item" data-target="dashboard-view">
                <i>📈</i>
                <span>Dashboard</span>
            </div>
        </div>
        
        <!-- Confirmation Popup -->
        <div class="confirmation-popup" id="confirmation-popup">
            <div class="confirmation-content">
                <div class="checkmark"></div>
                <h3>Operation Successful!</h3>
                <p id="confirmation-message">Your action has been completed</p>
                <button class="btn btn-primary" style="margin-top: 20px;" id="close-confirmation">OK</button>
            </div>
        </div>
        
        <!-- Modal for charge configuration -->
        <div class="modal" id="charges-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Courier Charges</div>
                    <div class="close-modal">×</div>
                </div>
                
                <div class="form-group">
                    <label>Set charges per customer return (₹)</label>
                    <div class="charge-config" id="charge-config">
                        <!-- Charges will be populated here -->
                    </div>
                    <button id="add-courier" class="btn btn-secondary" style="margin-top: 10px;">+ Add Courier</button>
                </div>
                
                <button id="save-charges" class="btn btn-primary">Save Charges</button>
            </div>
        </div>
        
        <!-- Audio element for beep sound -->
        <audio id="beep-sound" src="https://www.soundjay.com/buttons/sounds/beep-01a.mp3" preload="auto"></audio>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAfi1U9EqEPsSII4f5oqJrnHuVZeK6IrEU",
            authDomain: "seller-panel-4122b.firebaseapp.com",
            projectId: "seller-panel-4122b",
            storageBucket: "seller-panel-4122b.appspot.com",
            messagingSenderId: "466140503943",
            appId: "1:466140503943:web:d097604db592ec79fa3d22",
            measurementId: "G-FCZ4WQ8S3R"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Current seller state
        let currentSeller = "AAA";
        let products = [];
        let orders = [];
        let returns = [];
        let purchases = [];
        let couriers = [
            { id: "shadowfax", name: "Shadowfax", color: "sf", charge: 25 },
            { id: "ecom", name: "Ecom", color: "ec", charge: 30 },
            { id: "delhivery", name: "Delhivery", color: "dl", charge: 35 },
            { id: "valmo", name: "Valmo", color: "vm", charge: 20 }
        ];
        let scannerActive = false;
        let rescanActive = false;
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Load courier charges from localStorage if available
            const savedCharges = localStorage.getItem('courierCharges');
            if(savedCharges) {
                couriers = JSON.parse(savedCharges);
            }

            // Set up all event listeners
            // Navigation
            document.querySelectorAll('.seller-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.seller-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentSeller = this.getAttribute('data-seller');
                    
                    if(currentSeller === 'combined') {
                        showToast('Showing combined data for both sellers');
                    } else {
                        showToast(`Switched to ${this.textContent}`);
                    }
                    
                    // Reload seller-specific data
                    setupRealtimeListeners();
                    loadDashboardData(document.querySelector('.filter-btn.active').dataset.period);
                });
            });
            
            document.querySelectorAll('.feature-card').forEach(card => {
                card.addEventListener('click', function() {
                    const targetView = this.getAttribute('data-target');
                    showView(targetView);
                    
                    // Load data when switching to specific views
                    if(targetView === 'dashboard-view') {
                        loadDashboardData(document.querySelector('.filter-btn.active').dataset.period);
                    }
                });
            });
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const targetView = this.getAttribute('data-target');
                    showView(targetView);
                    
                    // Load data when switching to specific views
                    if(targetView === 'dashboard-view') {
                        loadDashboardData(document.querySelector('.filter-btn.active').dataset.period);
                    }
                });
            });
            
            document.querySelectorAll('.back-btn').forEach(btn => {
                btn.addEventListener('click', () => showView('home-view'));
            });
            
            // Barcode generation
            document.getElementById('barcode-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const productName = document.getElementById('product-name').value.trim();
                const size = document.getElementById('product-size').value.trim();
                const color = document.getElementById('product-color').value.trim();
                const profitMargin = document.getElementById('profit-margin').value.trim();
                
                if (!productName || !size || !color || !profitMargin) {
                    showToast('Please fill all fields');
                    return;
                }
                
                // Generate barcode
                const barcodeValue = `${productName}.${size}.${color}`;
                generateBarcode(barcodeValue);
                
                // Show result container
                document.getElementById('barcode-result').style.display = 'block';
            });
            
            document.getElementById('download-barcode').addEventListener('click', downloadBarcode);
            document.getElementById('save-barcode').addEventListener('click', saveToInventory);
            
            // Scanner
            document.getElementById('start-scanning').addEventListener('click', startScanner);
            document.getElementById('stop-scanning').addEventListener('click', stopScanner);
            document.getElementById('confirm-order').addEventListener('click', confirmOrder);
            
            // Returns
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    const tab = this.getAttribute('data-tab');
                    
                    // Hide all sections
                    document.querySelectorAll('.return-section').forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    // Show selected section
                    document.getElementById(`${tab}-return-section`).style.display = 'block';
                });
            });
            
            document.getElementById('process-customer-return').addEventListener('click', processCustomerReturn);
            document.getElementById('process-rto-return').addEventListener('click', processRtoReturn);
            
            // Rescan
            document.getElementById('start-rescan').addEventListener('click', startRescan);
            document.getElementById('stop-rescan').addEventListener('click', stopRescan);
            document.getElementById('confirm-rescan').addEventListener('click', confirmRescan);
            
            // Charges modal
            document.getElementById('configure-charges').addEventListener('click', showChargesModal);
            document.querySelector('.close-modal').addEventListener('click', hideChargesModal);
            document.getElementById('save-charges').addEventListener('click', saveCharges);
            document.getElementById('add-courier').addEventListener('click', addCourier);
            
            // Purchase history
            document.getElementById('add-item').addEventListener('click', addPurchaseItem);
            document.getElementById('purchase-form').addEventListener('submit', savePurchase);
            
            // Confirmation popup
            document.getElementById('close-confirmation').addEventListener('click', () => {
                document.getElementById('confirmation-popup').classList.remove('active');
            });
            
            // Dashboard filters
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    loadDashboardData(this.dataset.period);
                });
            });
            
            // Update inventory
            document.getElementById('update-inventory').addEventListener('click', updateInventory);
            
            // Reset all data button
            document.getElementById('reset-all-btn').addEventListener('click', resetAllDataWithPassword);
            
            // View details buttons
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('view-details-btn')) {
                    document.getElementById('daily-records').style.display = 'block';
                    document.getElementById('records-title').textContent = 
                        `${e.target.dataset.type === 'orders' ? 'Order' : 'Return'} Details`;
                }
            });

            // Load initial data
            // Load inventory (common for all sellers)
            loadInventory();
            
            // Load purchases (common for all sellers)
            loadPurchases();
            
            // Load analytics data
            loadDashboardData('daily');
            
            // Set up real-time listeners
            setupRealtimeListeners();
        });

        function generateBarcode(value) {
            JsBarcode("#barcode", value, {
                format: "CODE128",
                displayValue: true,
                fontSize: 14,
                height: 50,
                margin: 10,
                width: 2,
                lineColor: "#000",
                background: "#fff"
            });
        }
        
        function downloadBarcode() {
            const svgElement = document.getElementById('barcode');
            const svgData = new XMLSerializer().serializeToString(svgElement);
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            const img = new Image();
            
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                const pngFile = canvas.toDataURL("image/png");
                const downloadLink = document.createElement("a");
                downloadLink.download = `barcode_${new Date().getTime()}.png`;
                downloadLink.href = pngFile;
                downloadLink.click();
            };
            
            img.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svgData)));
            showToast('Barcode downloaded!');
        }
        
        function saveToInventory() {
            const productName = document.getElementById('product-name').value.trim();
            const size = document.getElementById('product-size').value.trim();
            const color = document.getElementById('product-color').value.trim();
            const profitMargin = parseFloat(document.getElementById('profit-margin').value);
            
            if (!productName || !size || !color || isNaN(profitMargin)) {
                showToast('Please generate barcode first');
                return;
            }
            
            // Add to common inventory collection
            const productId = `${productName}-${size}-${color}`.toLowerCase().replace(/\s+/g, '_');
            
            db.collection("common_inventory").doc(productId).set({
                name: productName,
                size: size,
                color: color,
                profit: profitMargin,
                barcode: `${productName}.${size}.${color}`,
                stock: 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                showToast('Product saved to inventory!');
                document.getElementById('barcode-form').reset();
                document.getElementById('barcode-result').style.display = 'none';
            })
            .catch(error => {
                console.error("Error saving product: ", error);
                showToast('Error saving product');
            });
        }
        
        function loadInventory() {
            const inventoryList = document.getElementById('inventory-list');
            inventoryList.innerHTML = '<div class="empty-state"><i>⏳</i><h3>Loading inventory...</h3></div>';
            
            db.collection("common_inventory").get()
            .then(snapshot => {
                products = [];
                snapshot.forEach(doc => {
                    products.push({id: doc.id, ...doc.data()});
                });
                renderInventory();
            })
            .catch(error => {
                console.error("Error loading inventory: ", error);
                inventoryList.innerHTML = '<div class="empty-state"><i>⚠️</i><h3>Error loading inventory</h3><p>Please try again later</p></div>';
            });
        }
        
        function renderInventory() {
            const inventoryList = document.getElementById('inventory-list');
            
            if(products.length === 0) {
                inventoryList.innerHTML = '<div class="empty-state"><i>📦</i><h3>No products in inventory</h3><p>Add products using the barcode generator</p></div>';
                return;
            }
            
            inventoryList.innerHTML = '';
            
            products.forEach(product => {
                const item = document.createElement('div');
                item.className = 'inventory-item';
                item.dataset.id = product.id;
                item.innerHTML = `
                    <div class="item-info">
                        <h4>${product.name}.${product.size}.${product.color}</h4>
                        <p>Profit: ₹${product.profit} per unit | Stock: ${product.stock}</p>
                    </div>
                    <div class="stock-control">
                        <button class="stock-btn minus">-</button>
                        <input type="number" class="stock-input" value="${product.stock}" min="0">
                        <button class="stock-btn plus">+</button>
                    </div>
                    <button class="delete-item">×</button>
                `;
                
                // Add event listeners
                item.querySelector('.minus').addEventListener('click', function() {
                    const input = this.parentElement.querySelector('.stock-input');
                    let count = parseInt(input.value);
                    if (count > 0) {
                        count--;
                        input.value = count;
                    }
                });
                
                item.querySelector('.plus').addEventListener('click', function() {
                    const input = this.parentElement.querySelector('.stock-input');
                    let count = parseInt(input.value);
                    count++;
                    input.value = count;
                });
                
                item.querySelector('.stock-input').addEventListener('change', function() {
                    let value = parseInt(this.value);
                    if (isNaN(value) || value < 0) {
                        this.value = 0;
                    }
                });
                
                item.querySelector('.delete-item').addEventListener('click', function() {
                    const item = this.closest('.inventory-item');
                    const productId = item.dataset.id;
                    
                    if(confirm("Are you sure you want to delete this product?")) {
                        db.collection("common_inventory").doc(productId).delete()
                        .then(() => {
                            showToast('Product deleted successfully!');
                        })
                        .catch(error => {
                            console.error("Error deleting product: ", error);
                            showToast('Error deleting product');
                        });
                    }
                });
                
                inventoryList.appendChild(item);
            });
        }
        
        function updateInventory() {
            const items = document.querySelectorAll('.inventory-item');
            const updates = [];
            
            items.forEach(item => {
                const productId = item.dataset.id;
                const stockValue = parseInt(item.querySelector('.stock-input').value);
                
                updates.push(
                    db.collection("common_inventory").doc(productId).update({
                        stock: stockValue
                    })
                );
            });
            
            Promise.all(updates)
            .then(() => {
                showToast('All inventory updated!');
            })
            .catch(error => {
                console.error("Error updating inventory: ", error);
                showToast('Error updating some items');
            });
        }
        
        function startScanner() {
            const video = document.getElementById('scanner-video');
            
            // Clear any existing stream
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }

            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            }).then(function(stream) {
                video.srcObject = stream;
                video.play();
                scannerActive = true;

                // Show/hide proper buttons
                document.getElementById('start-scanning').style.display = 'none';
                document.getElementById('stop-scanning').style.display = 'block';
                document.getElementById('scanned-result').style.display = 'none';

                // Initialize Quagga
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: video,
                        constraints: {
                            width: 640,
                            height: 480,
                            facingMode: "environment"
                        },
                    },
                    decoder: {
                        readers: ["code_128_reader"],
                        debug: {
                            showCanvas: false,
                            showPatches: false,
                            showFoundPatches: false,
                            showSkeleton: false,
                            showLabels: false,
                            showPatchLabels: false,
                            showRemainingPatchLabels: false,
                            boxFromPatches: {
                                showTransformed: false,
                                showTransformedBox: false,
                                showBB: false
                            }
                        }
                    },
                    locate: true
                }, function(err) {
                    if (err) {
                        console.error(err);
                        showToast('Scanner initialization error');
                        return;
                    }
                    
                    Quagga.start();
                    
                    // Detect when a barcode is found
                    Quagga.onDetected(function(result) {
                        const code = result.codeResult.code;
                        document.getElementById('scanned-product').value = code;
                        document.getElementById('scanned-result').style.display = 'block';
                        
                        // Play beep sound
                        playBeepSound();
                    });
                });
            })
            .catch(function(err) {
                console.error("Error accessing camera: ", err);
                showToast('Camera access denied or not supported');
            });
        }
        
        function stopScanner() {
            const video = document.getElementById('scanner-video');
            const stream = video.srcObject;
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            if (scannerActive) {
                Quagga.stop();
                scannerActive = false;
            }
            
            // Show start button
            document.getElementById('start-scanning').style.display = 'block';
            document.getElementById('stop-scanning').style.display = 'none';
            document.getElementById('scanned-result').style.display = 'none';
        }
        
        function confirmOrder() {
            const productBarcode = document.getElementById('scanned-product').value.trim();
            const quantity = parseInt(document.getElementById('order-quantity').value);
            
            if (!productBarcode || !quantity || quantity < 1) {
                showToast('Please scan a product and enter valid quantity');
                return;
            }
            
            // Find product in inventory
            const product = products.find(p => p.barcode === productBarcode);
            if (!product) {
                showToast('Product not found in inventory');
                return;
            }
            
            if (product.stock < quantity) {
                showToast('Not enough stock available');
                return;
            }
            
            // Create order
            const order = {
                productId: product.id,
                productName: product.name,
                size: product.size,
                color: product.color,
                quantity: quantity,
                profit: product.profit * quantity,
                seller: currentSeller === "combined" ? "AAA" : currentSeller, // Default to AAA if combined view
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Save to Firestore (seller-specific collection)
            db.collection(`sellers/${currentSeller === "combined" ? "AAA" : currentSeller}/orders`).add(order)
            .then(() => {
                // Update inventory (common collection)
                const newStock = product.stock - quantity;
                return db.collection("common_inventory").doc(product.id).update({
                    stock: newStock
                });
            })
            .then(() => {
                showToast(`Order processed: ${quantity} x ${productBarcode}`);
                playBeepSound();
                stopScanner();
                document.getElementById('order-quantity').value = 1;
            })
            .catch(error => {
                console.error("Error processing order: ", error);
                showToast('Error processing order');
            });
        }
        
        function processCustomerReturn() {
            const courier = document.getElementById('return-courier').value;
            const quantity = parseInt(document.getElementById('customer-return-qty').value);
            const wrongReturns = parseInt(document.getElementById('wrong-return-qty').value);
            const claims = parseInt(document.getElementById('claims-received').value);
            const compensation = parseFloat(document.getElementById('compensation-amount').value);
            
            if (!courier || !quantity || quantity < 1) {
                showToast('Please select a courier and enter valid quantity');
                return;
            }
            
            // Get charge for this courier
            const courierData = couriers.find(c => c.id === courier);
            const charge = courierData ? courierData.charge : 0;
            
            // Create return record
            const returnData = {
                type: "customer",
                courier: courier,
                quantity: quantity,
                wrongReturns: wrongReturns,
                claims: claims,
                compensation: compensation,
                charge: charge * quantity,
                seller: currentSeller === "combined" ? "AAA" : currentSeller, // Default to AAA if combined view
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Save to Firestore (seller-specific collection)
            db.collection(`sellers/${currentSeller === "combined" ? "AAA" : currentSeller}/returns`).add(returnData)
            .then(() => {
                showConfirmation("Return processed successfully!");
                playBeepSound();
                showToast(`Processed ${quantity} customer returns`);
                
                // Reset form
                document.getElementById('customer-return-qty').value = 1;
                document.getElementById('wrong-return-qty').value = 0;
                document.getElementById('claims-received').value = 0;
                document.getElementById('compensation-amount').value = 0;
            })
            .catch(error => {
                console.error("Error saving return: ", error);
                showToast('Error processing return');
            });
        }
        
        function processRtoReturn() {
            const courier = document.getElementById('rto-courier').value;
            const quantity = parseInt(document.getElementById('rto-return-qty').value);
            
            if (!courier || !quantity || quantity < 1) {
                showToast('Please select a courier and enter valid quantity');
                return;
            }
            
            // Create return record (no charge for RTO)
            const returnData = {
                type: "rto",
                courier: courier,
                quantity: quantity,
                seller: currentSeller === "combined" ? "AAA" : currentSeller, // Default to AAA if combined view
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Save to Firestore (seller-specific collection)
            db.collection(`sellers/${currentSeller === "combined" ? "AAA" : currentSeller}/returns`).add(returnData)
            .then(() => {
                showConfirmation("RTO return processed!");
                playBeepSound();
                showToast(`Processed ${quantity} RTO returns`);
                
                // Reset form
                document.getElementById('rto-return-qty').value = 1;
            })
            .catch(error => {
                console.error("Error saving return: ", error);
                showToast('Error processing return');
            });
        }
        
        function startRescan() {
            const video = document.getElementById('rescan-video');
            
            // First check if scanner is already active
            if (rescanActive) return;
            
            // Clear any existing stream
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }

            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            }).then(function(stream) {
                video.srcObject = stream;
                video.play();
                rescanActive = true;

                // Show/hide proper buttons
                document.getElementById('start-rescan').style.display = 'none';
                document.getElementById('stop-rescan').style.display = 'block';
                document.getElementById('scanned-rescan-result').style.display = 'none';

                // Initialize Quagga with proper configuration
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: video,
                        constraints: {
                            width: 640,
                            height: 480,
                            facingMode: "environment"
                        },
                    },
                    decoder: {
                        readers: ["code_128_reader"],
                        debug: false
                    },
                    locate: true
                }, function(err) {
                    if (err) {
                        console.error(err);
                        showToast('Scanner initialization error');
                        stopRescan();
                        return;
                    }
                    
                    Quagga.start();
                    
                    // Detect when a barcode is found
                    Quagga.onDetected(function(result) {
                        const code = result.codeResult.code;
                        document.getElementById('rescan-product').value = code;
                        document.getElementById('scanned-rescan-result').style.display = 'block';
                        
                        // Play beep sound
                        playBeepSound();
                        
                        // Auto-focus on quantity field
                        document.getElementById('rescan-quantity').focus();
                    });
                });
            })
            .catch(function(err) {
                console.error("Error accessing camera: ", err);
                showToast('Camera access denied or not supported');
                stopRescan();
            });
        }
        
        function stopRescan() {
            const video = document.getElementById('rescan-video');
            const stream = video.srcObject;
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            if (rescanActive) {
                Quagga.stop();
                rescanActive = false;
            }
            
            // Show start button
            document.getElementById('start-rescan').style.display = 'block';
            document.getElementById('stop-rescan').style.display = 'none';
            document.getElementById('scanned-rescan-result').style.display = 'none';
        }
        
        function confirmRescan() {
            const productBarcode = document.getElementById('rescan-product').value.trim();
            const quantity = parseInt(document.getElementById('rescan-quantity').value);
            
            if (!productBarcode || !quantity || quantity < 1) {
                showToast('Please scan a product and enter valid quantity');
                return;
            }
            
            // Find product in inventory
            const product = products.find(p => p.barcode === productBarcode);
            if (!product) {
                showToast('Product not found in inventory');
                return;
            }
            
            // Update inventory (common collection)
            const newStock = product.stock + quantity;
            db.collection("common_inventory").doc(product.id).update({
                stock: newStock
            })
            .then(() => {
                showToast(`Added ${quantity} items to inventory: ${productBarcode}`);
                playBeepSound();
                document.getElementById('rescan-quantity').value = 1;
                stopRescan();
            })
            .catch(error => {
                console.error("Error updating stock: ", error);
                showToast('Error adding to inventory');
            });
        }
        
        function showChargesModal() {
            const chargeConfig = document.getElementById('charge-config');
            chargeConfig.innerHTML = '';
            
            couriers.forEach(courier => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <div class="charge-label">${courier.name}</div>
                    <input type="number" class="charge-input" value="${courier.charge}" data-id="${courier.id}" min="0" step="0.01">
                `;
                chargeConfig.appendChild(div);
            });
            
            document.getElementById('charges-modal').classList.add('active');
        }
        
        function hideChargesModal() {
            document.getElementById('charges-modal').classList.remove('active');
        }
        
        function saveCharges() {
            const inputs = document.querySelectorAll('.charge-input');
            inputs.forEach(input => {
                const courierId = input.dataset.id;
                const charge = parseFloat(input.value);
                
                // Find courier and update
                const courier = couriers.find(c => c.id === courierId);
                if(courier) {
                    courier.charge = charge;
                }
            });
            
            // Save to localStorage
            localStorage.setItem('courierCharges', JSON.stringify(couriers));
            
            hideChargesModal();
            showToast('Courier charges updated!');
        }
        
        function addCourier() {
            const name = prompt("Enter courier name:");
            if (!name) return;
            
            const id = name.toLowerCase().replace(/\s+/g, '_');
            const colors = ['sf', 'ec', 'dl', 'vm'];
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            
            const newCourier = {
                id: id,
                name: name,
                color: randomColor,
                charge: 25
            };
            
            couriers.push(newCourier);
            
            // Add to the UI
            const chargeConfig = document.getElementById('charge-config');
            const div = document.createElement('div');
            div.innerHTML = `
                <div class="charge-label">${name}</div>
                <input type="number" class="charge-input" value="25" data-id="${id}" min="0" step="0.01">
            `;
            chargeConfig.appendChild(div);
        }
        
        function addPurchaseItem() {
            const container = document.getElementById('purchase-items');
            const newItem = document.createElement('div');
            newItem.className = 'purchase-item';
            newItem.innerHTML = `
                <div class="item-row">
                    <input type="text" class="form-control item-name" placeholder="Item name">
                    <input type="number" class="form-control item-qty" placeholder="Qty" min="1">
                    <input type="number" class="form-control item-price" placeholder="Price (₹)" min="0" step="0.01">
                </div>
            `;
            container.appendChild(newItem);
        }
        
        function savePurchase(e) {
            e.preventDefault();
            
            const vendor = document.getElementById('vendor-name').value.trim();
            const date = document.getElementById('purchase-date').value;
            const total = parseFloat(document.getElementById('total-amount').value);
            
            if (!vendor || !date || isNaN(total)) {
                showToast('Please fill all required fields');
                return;
            }
            
            // Collect items
            const items = [];
            document.querySelectorAll('.purchase-item').forEach(item => {
                const name = item.querySelector('.item-name').value.trim();
                const qty = parseInt(item.querySelector('.item-qty').value);
                const price = parseFloat(item.querySelector('.item-price').value);
                
                if (name && !isNaN(qty) && qty > 0 && !isNaN(price) && price >= 0) {
                    items.push({
                        name: name,
                        quantity: qty,
                        price: price
                    });
                }
            });
            
            if (items.length === 0) {
                showToast('Please add at least one valid item');
                return;
            }
            
            // Create purchase record
            const purchase = {
                vendor: vendor,
                date: date,
                items: items,
                total: total,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Save to Firestore (common collection)
            db.collection("common_purchases").add(purchase)
            .then(() => {
                showToast('Purchase saved successfully!');
                document.getElementById('purchase-form').reset();
                
                // Reset items to just one
                const container = document.getElementById('purchase-items');
                container.innerHTML = `
                    <div class="purchase-item">
                        <div class="item-row">
                            <input type="text" class="form-control item-name" placeholder="Item name">
                            <input type="number" class="form-control item-qty" placeholder="Qty" min="1">
                            <input type="number" class="form-control item-price" placeholder="Price (₹)" min="0" step="0.01">
                        </div>
                    </div>
                `;
            })
            .catch(error => {
                console.error("Error saving purchase: ", error);
                showToast('Error saving purchase');
            });
        }
        
        function loadPurchases() {
            db.collection("common_purchases").orderBy("timestamp", "desc").limit(10).get()
            .then(snapshot => {
                purchases = [];
                snapshot.forEach(doc => {
                    purchases.push({id: doc.id, ...doc.data()});
                });
                renderPurchasesTable();
            })
            .catch(error => {
                console.error("Error loading purchases: ", error);
            });
        }
        
        function renderPurchasesTable() {
            const tableBody = document.querySelector('#purchases-table tbody');
            tableBody.innerHTML = '';
            
            if (purchases.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No purchases recorded yet</td></tr>';
                return;
            }
            
            purchases.forEach(purchase => {
                const row = document.createElement('tr');
                
                // Format date
                const date = new Date(purchase.timestamp?.seconds * 1000 || purchase.date);
                const formattedDate = date.toLocaleDateString('en-IN');
                
                // Count items
                const itemCount = purchase.items.reduce((sum, item) => sum + item.quantity, 0);
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${purchase.vendor}</td>
                    <td>${itemCount} items</td>
                    <td>₹${purchase.total.toFixed(2)}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        function loadDashboardData(period) {
            // Calculate date range based on period
            let startDate = new Date();
            let endDate = new Date();
            
            switch(period) {
                case 'daily':
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'weekly':
                    startDate.setDate(startDate.getDate() - startDate.getDay()); // Start of week
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'monthly':
                    startDate.setDate(1);
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'all':
                    startDate = new Date(0); // Unix epoch
                    break;
            }
            
            // Convert to Firestore timestamps
            const startTimestamp = firebase.firestore.Timestamp.fromDate(startDate);
            const endTimestamp = firebase.firestore.Timestamp.fromDate(endDate);
            
            // Query orders and returns based on current seller
            const ordersQuery = currentSeller === "combined" ? 
                db.collectionGroup('orders') : 
                db.collection(`sellers/${currentSeller}/orders`);
            
            const returnsQuery = currentSeller === "combined" ? 
                db.collectionGroup('returns') : 
                db.collection(`sellers/${currentSeller}/returns`);
            
            // Get orders in period
            ordersQuery.where("timestamp", ">=", startTimestamp)
                .where("timestamp", "<=", endTimestamp)
                .get()
                .then(ordersSnapshot => {
                    orders = [];
                    ordersSnapshot.forEach(doc => {
                        orders.push({id: doc.id, ...doc.data()});
                    });
                    
                    // Get returns in period
                    return returnsQuery.where("timestamp", ">=", startTimestamp)
                        .where("timestamp", "<=", endTimestamp)
                        .get();
                })
                .then(returnsSnapshot => {
                    returns = [];
                    returnsSnapshot.forEach(doc => {
                        returns.push({id: doc.id, ...doc.data()});
                    });
                    
                    // Update dashboard with real data
                    updateDashboard();
                })
                .catch(error => {
                    console.error("Error loading dashboard data: ", error);
                    showToast('Error loading dashboard data');
                });
        }
        
        function updateDashboard() {
            // Calculate totals
            const totalOrders = orders.length;
            const totalReturns = returns.reduce((sum, r) => sum + r.quantity, 0);
            
            // Calculate earnings (sum of all order profits)
            const totalEarnings = orders.reduce((sum, o) => sum + o.profit, 0);
            
            // Calculate return charges (sum of all customer return charges)
            const returnCharges = returns
                .filter(r => r.type === "customer")
                .reduce((sum, r) => sum + (r.charge || 0), 0);
            
            // Net profit/loss
            const netProfit = totalEarnings - returnCharges;
            
            // Update UI
            document.getElementById('total-orders').textContent = totalOrders;
            document.getElementById('total-returns').textContent = totalReturns;
            document.getElementById('total-earnings').textContent = `₹${totalEarnings.toFixed(2)}`;
            document.getElementById('return-charges').textContent = `₹${returnCharges.toFixed(2)}`;
            document.getElementById('net-profit').textContent = `₹${netProfit.toFixed(2)}`;
            
            // Update daily records table
            updateDailyRecordsTable();
        }
        
        function updateDailyRecordsTable() {
            const tableBody = document.querySelector('#daily-records-table tbody');
            tableBody.innerHTML = '';
            
            // Group data by day
            const dailyData = {};
            
            // Process orders
            orders.forEach(order => {
                const date = order.timestamp?.toDate() || new Date();
                const dateStr = date.toISOString().split('T')[0];
                
                if (!dailyData[dateStr]) {
                    dailyData[dateStr] = {
                        date: dateStr,
                        orders: 0,
                        returns: 0,
                        earnings: 0,
                        charges: 0
                    };
                }
                
                dailyData[dateStr].orders += 1;
                dailyData[dateStr].earnings += order.profit;
            });
            
            // Process returns
            returns.forEach(ret => {
                const date = ret.timestamp?.toDate() || new Date();
                const dateStr = date.toISOString().split('T')[0];
                
                if (!dailyData[dateStr]) {
                    dailyData[dateStr] = {
                        date: dateStr,
                        orders: 0,
                        returns: 0,
                        earnings: 0,
                        charges: 0
                    };
                }
                
                dailyData[dateStr].returns += ret.quantity;
                
                if (ret.type === "customer") {
                    dailyData[dateStr].charges += ret.charge || 0;
                }
            });
            
            // Sort dates descending
            const sortedDates = Object.keys(dailyData).sort((a, b) => new Date(b) - new Date(a));
            
            // Populate table
            sortedDates.forEach(date => {
                const data = dailyData[date];
                const row = document.createElement('tr');
                
                // Format date for display
                const displayDate = new Date(date).toLocaleDateString('en-IN', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });
                
                row.innerHTML = `
                    <td>${displayDate}</td>
                    <td>${data.orders}</td>
                    <td>${data.returns}</td>
                    <td>₹${data.earnings.toFixed(2)}</td>
                    <td>₹${data.charges.toFixed(2)}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        function resetAllDataWithPassword() {
            const password = prompt("Enter admin password to reset all data:");
            if (password !== "Arshad1606") {
                showToast("Incorrect password");
                return;
            }
            
            if (confirm("WARNING: This will delete ALL data. Are you sure?")) {
                // Delete all collections
                const batch = db.batch();
                
                // Delete common inventory
                db.collection("common_inventory").get().then(snapshot => {
                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    return db.collection("common_purchases").get();
                })
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    return db.collectionGroup('orders').get();
                })
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    return db.collectionGroup('returns').get();
                })
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    return batch.commit();
                })
                .then(() => {
                    showToast("All data has been reset");
                    loadInitialData();
                })
                .catch(error => {
                    console.error("Error resetting data: ", error);
                    showToast("Error resetting data");
                });
            }
        }
        
        function playBeepSound() {
            const beep = document.getElementById('beep-sound');
            beep.currentTime = 0;
            beep.play().catch(e => console.log("Audio play failed:", e));
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        function showConfirmation(message) {
            document.getElementById('confirmation-message').textContent = message;
            document.getElementById('confirmation-popup').classList.add('active');
        }
        
        function showView(viewId) {
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            
            // Show selected view
            document.getElementById(viewId).classList.add('active');
            
            // Update bottom nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.getAttribute('data-target') === viewId);
            });
            
            // Stop scanners when leaving scanner views
            if(viewId !== 'scanner-view' && scannerActive) {
                stopScanner();
            }
            if(viewId !== 'returns-view' && rescanActive) {
                stopRescan();
            }
            
            // Hide daily records when leaving dashboard
            if(viewId !== 'dashboard-view') {
                document.getElementById('daily-records').style.display = 'none';
            }
        }
    </script>
</body>
</html>
